"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9047],{80311:(e,n,t)=>{t.d(n,{V1:()=>i});let r=new Map,o=0;function a(e){if("string"!=typeof e)return;let n=e.trim();return n.length>0?n:void 0}function i(e,n){var t,i,l;let s=function(e){let n=a(e.id),t=a(e.label),r=a(e.kind);return{id:null!=n?n:"",...void 0!==t?{label:t}:{},...void 0!==r?{kind:r}:{}}}(e);if(0===s.id.length)return;let u=function(e){if("number"!=typeof e||!Number.isFinite(e)||e<0)return null;let n=Math.round(e);return n>0?n:0}(n);if(null===u)return;let c=r.get(s.id),d=null!=(t=null==c?void 0:c.tokens)?t:0;if(0===u){c&&(i=s.id,r.delete(i),(o-=d)<0&&(o=0));return}let m=(l=null==c?void 0:c.metadata,{id:s.id,...(null==l?void 0:l.label)?{label:l.label}:{},...(null==l?void 0:l.kind)?{kind:l.kind}:{},...void 0!==s.label?{label:s.label}:{},...void 0!==s.kind?{kind:s.kind}:{}});r.set(s.id,{metadata:m,tokens:u}),(o+=u-d)<0&&(o=0)}},99047:(e,n,t)=>{let r;t.d(n,{planWithAssistantAction:()=>V});var o=t(99762),a=t(84804),i=t(90511),l=t(80311),s=t(27566),u=t(87358);let c=/[\u0000-\u0008\u000b\u000c\u000e-\u001f\u007f\u2028\u2029]/g,d=/[\u200b-\u200f\u202a-\u202e\u2060-\u2064\u2066-\u2069\ufeff]/gi,m=/[ \t\f\v]+/g,f=N("SAFE_MODE_RESPONSE_RESERVE",512,{min:0,integer:!0}),p=N("SAFE_MODE_TEMPERATURE_CEILING",.4,{min:0}),g=N("SAFE_MODE_MAX_TOOL_CALLS",1,{min:0,integer:!0}),h=new Set;function v(e){let n=[];for(let r of e)if("string"==typeof r||"number"==typeof r)n.push(r);else{var t;n.push(null!=(t=r.description)?t:r.toString())}return n}function k(e){return e.code===o.eqx.invalid_type&&"string"==typeof e.message&&/received undefined$/u.test(e.message)?"Required":e.message}function b(e,n){"undefined"!=typeof console&&(h.has(e)||(h.add(e),console.warn(n)))}function E(e,n,t){let r="number"==typeof n?n.toString():JSON.stringify(n);b("estimate:".concat(e,":").concat(t),"[ai.safety] Token estimator produced ".concat(t," for message index ").concat(e,'; clamping "').concat(r,'" to a safe integer budget.'))}function y(e){return 0===e.length?"<root>":e.reduce((e,n)=>"number"==typeof n?"".concat(e,"[").concat(n,"]"):0===e.length?n:"".concat(e,".").concat(n),"")}function _(e){if(0===e.length)return[];if(void 0===r){let e="undefined"!=typeof Intl?Intl:void 0,n=null==e?void 0:e.Segmenter;r="function"==typeof n?new n(void 0,{granularity:"grapheme"}):null}let n=r;return n?Array.from(n.segment(e),e=>e.segment):Array.from(e)}let M=new Set(["1","true","on","yes"]);function T(e,n,t){let r=n.trim();b("numeric:".concat(e,":").concat(t,":").concat(r),"[ai.safety] Ignoring ".concat(e,' value "').concat(r,'" (').concat(t,")."))}function N(e,n){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(void 0===u)return n;for(let n of Array.isArray(e)?e:[e]){let e=u.env[n];if("string"!=typeof e)continue;let r=e.trim();if(0===r.length){T(n,e,"empty string");continue}let o=Number(r);if(!Number.isFinite(o)){T(n,e,"non-numeric value");continue}let a=t.integer?Math.trunc(o):o;if(Number.isNaN(a)){T(n,e,"not a number");continue}if(void 0!==t.min&&a<t.min){T(n,e,"below minimum ".concat(t.min));continue}return a}return n}function P(){return N("AI_MAX_INPUT_LENGTH",16e3,{min:1,integer:!0})}function A(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{maxLength:t=P(),allowMarkup:r=!1}=n,o=Number.isFinite(t)?Math.max(Math.trunc(t),0):P(),a=e.replace(/\r\n?/g,"\n").replace(c,"").replace(d,"").replace(/\n{3,}/g,"\n\n").split("\n").map(e=>e.replace(m," ").trimEnd()).join("\n").trim(),i=0===o?"":function(e,n){if(n<=0)return"";let t=_(e);return t.length<=n?e:t.slice(0,n).join("")}(a,o);return r?i:(0,s.jZ)(i)}function C(e){let n=N(["AI_TOKENS_PER_CHAR","AI_TOKENS_PER_CHARACTER"],4,{min:Number.EPSILON}),t=_(e).length;return 0===t?0:Math.ceil(t/n)}function S(e,n){var t,r,o,a;let s=null!=(t=n.estimateTokens)?t:C,c=null!=(r=n.reservedForResponse)?r:0,d=Number.isFinite(c)?Math.max(Math.floor(c),0):0,m=(0,i.If)(),p=function(){if(void 0===u)return!1;let e=u.env.SAFE_MODE;if("string"!=typeof e)return!1;let n=e.trim().toLowerCase();return 0!==n.length&&M.has(n)}(),g=m&&p,h=g?Math.max(d,f):d,v=Number.isFinite(n.maxTokens)?Math.max(Math.floor(n.maxTokens),0):0,k=Math.max((g?Math.min(v,N("SAFE_MODE_TOKEN_CEILING",8e3,{min:1,integer:!0})):v)-h,0),b=[],y=0,_=0;for(let n=e.length-1;n>=0;n-=1){let t=e[n],r=(o=s(t.content),a=n,Number.isFinite(o)?o<0?(E(a,o,"a negative value"),0):(Number.isInteger(o)||E(a,o,"a fractional value"),Math.ceil(o)):(E(a,o,"a non-finite value"),0));if(t.pinned){b.push(t),y+=r;continue}if(y+r>k){_+=1;continue}b.push(t),y+=r}b.reverse();let T={messages:b,removedCount:_,totalTokens:y,availableTokens:k};return n.agent&&(0,l.V1)(n.agent,T.totalTokens),T}let w=Number.EPSILON;var x=t(78374),I=t(87358);let F="You are Planner, an assistant that helps people organise projects and daily tasks.\nExtract actionable planner suggestions from the user's description and keep responses concise.\nPrioritise clear wording and surface any detected dates, times, or recurring patterns.",O=new Set(["1","true","on","yes"]),j={id:"planner.assistant",label:"Planner Assistant",kind:"planner"},L=o.Ikc({id:o.YjP(),title:o.YjP(),intent:o.KCZ([o.euz("task"),o.euz("project")]),confidence:o.KCZ([o.euz("none"),o.euz("low"),o.euz("medium"),o.euz("high")]),summary:o.YjP().nullable(),schedule:o.Ikc({date:o.YjP().optional(),time:o.YjP().optional()}).optional()}),D=o.Ikc({sanitizedPrompt:o.YjP(),prompt:o.YjP(),summary:o.YjP().nullable(),suggestions:o.YOg(L),safety:o.Ikc({safeMode:o.zMY(),temperature:o.aig(),toolChoice:o.Ikc({mode:o.KCZ([o.euz("auto"),o.euz("none"),o.euz("required")]),maxToolCalls:o.aig().int().nonnegative().optional()}),topP:o.aig().optional()}),tokenBudget:o.Ikc({totalTokens:o.aig().int().nonnegative(),availableTokens:o.aig().int().nonnegative(),removedCount:o.aig().int().nonnegative()})});class R extends Error{constructor(e,n){super(n),this.code=e,this.name="PlannerAssistantError"}}function Y(e,n){let t=n.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");return t?"".concat(e,"-").concat(t):"".concat(e)}var z=t(98986),q=t(87358);let X=new Set(["1","true","on","yes"]),K=new Set(["0","false","off","no"]);function U(e){if("string"!=typeof e)return null;let n=e.trim().toLowerCase();return n?!!X.has(n)||!K.has(n)&&null:null}function B(e,n){var t,r,o;return null!=(o=null!=(r=null!=(t=U(e))?t:U(n))?r:U(z.Vq))&&o}let G=o.Ikc({prompt:o.YjP(),focusDate:o.YjP().optional(),suggestionLimit:o.aig().int().positive().max(10).optional()});async function V(e){let n=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:q.env,n=B(e.SAFE_MODE,e.NEXT_PUBLIC_SAFE_MODE),t=B(e.NEXT_PUBLIC_SAFE_MODE,e.SAFE_MODE);return{server:n,client:t,active:n&&t}}();if(n.server!==n.client)return{ok:!1,error:"safe_mode_mismatch",message:"Planner assistant is disabled because SAFE_MODE and NEXT_PUBLIC_SAFE_MODE do not match.",safeMode:n};let t=G.safeParse(e);if(!t.success)return{ok:!1,error:"invalid_request",message:"Invalid planner assistant request.",safeMode:n,issues:t.error.issues.map(e=>({path:e.path,message:e.message}))};try{var r;let{prompt:e,focusDate:l,suggestionLimit:s}=t.data,u=l&&null!=(r=(0,a.E4)(l))?r:void 0,c=function(e){var n,t,r,a,l,s;let u=A(e.prompt,{allowMarkup:!0});if(!u)throw new R("empty_prompt","The planner assistant requires a non-empty prompt.");let c=A(e.prompt),d=function(){var e;let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=(0,i.If)(),r=function(e){if("number"!=typeof e||!Number.isFinite(e))return .7;let n=Math.min(Math.max(e,0),2);return Number.isNaN(n)?.7:n}(n.temperature),o=function(e){if("number"!=typeof e||!Number.isFinite(e))return;let n=Math.min(Math.max(e,w),1);return Number.isNaN(n)?void 0:n}(n.topP),a=function(e){let n=(null==e?void 0:e.mode)==="auto"||(null==e?void 0:e.mode)==="none"||(null==e?void 0:e.mode)==="required"?e.mode:"auto",t=function(e){if("number"!=typeof e||!Number.isFinite(e))return;let n=Math.max(0,Math.trunc(e));return Number.isNaN(n)?void 0:n}(null==e?void 0:e.maxToolCalls);return{mode:n,...void 0!==t?{maxToolCalls:t}:{}}}(n.toolChoice),l=t?Math.min(r,p):r,s=t?Math.min(null!=(e=a.maxToolCalls)?e:g,g):a.maxToolCalls,u=t?{mode:"none"===a.mode?"none":"auto",...void 0!==s?{maxToolCalls:s}:{}}:{mode:a.mode,...void 0!==s?{maxToolCalls:s}:{}};return{temperature:l,...void 0!==o?{topP:o}:{},toolChoice:u,safeMode:t}}(),m=d.safeMode&&function(e){if("string"!=typeof e)return!1;let n=e.trim().toLowerCase();return!!n&&O.has(n)}(I.env.SAFE_MODE),f=function(e,n){var t;if("string"==typeof e){let{pinned:r,...o}=n,a=S([{content:e,pinned:r}],o),i=a.messages[0];return{content:null!=(t=null==i?void 0:i.content)?t:null,removed:void 0===i,totalTokens:a.totalTokens,availableTokens:a.availableTokens}}return S(e,n)}([{role:"system",content:F,pinned:!0},{role:"user",content:u}],{maxTokens:null!=(t=e.maxTokens)?t:4e3,reservedForResponse:null!=(r=e.reservedForResponse)?r:512,agent:j}),h=function(e){let n=[...e].reverse().find(e=>"user"===e.role&&e.content.trim().length>0);return n?n.content.trim():""}(f.messages);if(!h)throw new R("budget_exhausted","The planner assistant could not keep the user's prompt within the token budget.");let E=function(e){let n=e.trim();if(!n)return[];let t=new Set;for(let e of(t.add(n),n.split(/\n+/).map(e=>e.replace(/^[-*•\u2022]\s*/,"").trim()).filter(e=>e.length>0)))t.add(e);return Array.from(t)}(h),_=null!=(a=e.now)?a:new Date,M=null!=(l=e.suggestionLimit)?l:m?3:5,T=Math.max(1,m?Math.min(M,3):M),N=(function(e){let n=new Set,t=[];for(let l of e){var r,o,a,i;let e=[l.intent,l.title.toLowerCase(),null!=(a=null==(r=l.schedule)?void 0:r.date)?a:"",null!=(i=null==(o=l.schedule)?void 0:o.time)?i:""].join("|");n.has(e)||(n.add(e),t.push(l))}return t})(E.slice(0,2*T).map((e,n)=>(function(e,n,t){var r,o;let a=(0,x.$J)(e,{now:n}),i=a.event.title.trim()||e,l=(0,x.iT)(a),s=function(e,n){if(e||n)return{...e?{date:e}:{},...n?{time:n}:{}}}(a.event.startDate,a.event.time);return{id:Y(t,"".concat(i,"-").concat(null!=(r=null==s?void 0:s.date)?r:"","-").concat(null!=(o=null==s?void 0:s.time)?o:"")),title:i,intent:a.intent,confidence:a.confidence,summary:l.length>0?l:null,...s?{schedule:s}:{}}})(e,_,n))).slice(0,T);N.length||N.push({id:Y(0,h),title:h,intent:"task",confidence:"none",summary:null});let P=null!=(s=null==(n=N[0])?void 0:n.summary)?s:null,C=function(e,n){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},{label:r="AI response"}=t;try{let t=n.parse(e);return{success:!0,data:t}}catch(n){if(!function(e,n){if(n instanceof o.GaX){let t=n.issues.map(e=>{let n=v(e.path),t=k(e);return"".concat(y(n)," → ").concat(t)}).join("; ");b("schema:".concat(e,":").concat(t),"[ai.safety] ".concat(e," failed schema validation: ").concat(t));return}let t=n instanceof Error?"".concat(n.name,": ").concat(n.message):String(n);b("schema:".concat(e,":").concat(t),"[ai.safety] ".concat(e," validation threw: ").concat(t))}(r,n),n instanceof o.GaX)return{success:!1,error:{label:r,issues:n.issues.map(e=>{let n=v(e.path);return{path:n,pathText:y(n),message:k(e),code:e.code}}),cause:n}};let e=n instanceof Error?n.message:"Unexpected validation error";return{success:!1,error:{label:r,issues:[{path:[],pathText:y([]),message:e}],cause:n}}}}({sanitizedPrompt:c,prompt:[F,"",h].join("\n"),summary:P,suggestions:N,safety:{...d,safeMode:m},tokenBudget:{totalTokens:f.totalTokens,availableTokens:f.availableTokens,removedCount:f.removedCount}},D,{label:"planner assistant plan"});if(!C.success)throw new R("invalid_plan","Planner assistant produced an invalid plan.");return C.data}({prompt:e,now:u,suggestionLimit:s});return{ok:!0,plan:c,safeMode:n}}catch(e){if(e instanceof R){if("empty_prompt"===e.code)return{ok:!1,error:e.code,message:"Describe your plan before asking the assistant.",safeMode:n};if("budget_exhausted"===e.code)return{ok:!1,error:e.code,message:"Planner assistant prompt exceeded the token budget.",safeMode:n};return{ok:!1,error:e.code,message:"Planner assistant produced an invalid response.",safeMode:n}}return{ok:!1,error:"internal_error",message:e instanceof Error?e.message:"Planner assistant failed.",safeMode:n}}}}}]);
//# sourceMappingURL=9047.d457965e5bc4270d.js.map