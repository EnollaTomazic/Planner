name: CI

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:
  push:
    branches:
      - main
      - work

jobs:
  lint:
    name: Lint
    uses: ./.github/workflows/node-base.yml
    with:
      run: npm run lint
      summary-title: Lint

  typecheck:
    name: Typecheck
    uses: ./.github/workflows/node-base.yml
    with:
      run: npm run typecheck
      summary-title: Typecheck

  unit:
    name: Unit Tests
    uses: ./.github/workflows/node-base.yml
    with:
      run: npm test -- --run
      summary-title: Unit Tests

  build:
    name: Build
    needs:
      - lint
      - typecheck
      - unit
    uses: ./.github/workflows/node-base.yml
    with:
      run: |
        set -euo pipefail
        npm audit --audit-level=moderate --json > audit-report.json || AUDIT_STATUS=$?
        if [ -n "${AUDIT_STATUS:-}" ] && [ "$AUDIT_STATUS" -ne 0 ]; then
          echo "npm audit reported issues below the high severity threshold."
        fi
        node scripts/audit-ci-report.mjs audit-report.json
        npm run build
      cache-path: .next/cache
      artifact-name: next-build
      artifact-path: |
        .next
      summary-title: Build

  e2e:
    name: E2E (${{ matrix.project }})
    needs:
      - build
    strategy:
      fail-fast: false
      matrix:
        project:
          - chromium
          - firefox
          - webkit
    uses: ./.github/workflows/node-base.yml
    with:
      run: |
        set -euo pipefail
        OUTPUT_DIR="playwright-results/${{ matrix.project }}"
        LIST_OUTPUT=$(npx playwright test --list --project=${{ matrix.project }} --grep "@axe") || true
        if echo "$LIST_OUTPUT" | grep -q "@axe"; then
          npx playwright test \
            --project=${{ matrix.project }} \
            --reporter=line \
            --trace=retain-on-failure \
            --output="$OUTPUT_DIR" \
            --grep "@axe"
        else
          echo "No @axe-tagged tests detected; running full suite." >&2
          npx playwright test \
            --project=${{ matrix.project }} \
            --reporter=line \
            --trace=retain-on-failure \
            --output="$OUTPUT_DIR"
        fi
      summary-title: E2E ${{ matrix.project }}
      install-playwright: true
      artifact-name: playwright-${{ matrix.project }}-artifacts
      artifact-path: |
        playwright-results/${{ matrix.project }}
      artifact-on-failure: true
