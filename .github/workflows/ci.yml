name: CI

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:
  push:
    branches:
      - main
      - work

jobs:
  lint:
    name: Lint
    uses: ./.github/workflows/node-base.yml
    with:
      run: npm run lint
      summary-title: Lint

  typecheck:
    name: Typecheck
    uses: ./.github/workflows/node-base.yml
    with:
      run: npm run typecheck
      summary-title: Typecheck

  unit:
    name: Unit Tests
    uses: ./.github/workflows/node-base.yml
    with:
      run: npm test -- --run
      summary-title: Unit Tests

  build:
    name: Build
    needs:
      - lint
      - typecheck
      - unit
    uses: ./.github/workflows/node-base.yml
    with:
      run: |
        set -euo pipefail
        npm audit --audit-level=moderate --json > audit-report.json || AUDIT_STATUS=$?
        if [ -n "${AUDIT_STATUS:-}" ] && [ "$AUDIT_STATUS" -ne 0 ]; then
          echo "npm audit reported issues below the high severity threshold."
        fi
        node scripts/audit-ci-report.mjs audit-report.json
        npm run build
      cache-path: .next/cache
      artifact-name: next-build
      artifact-path: |
        .next
      summary-title: Build
