name: CI

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:
  push:
    branches:
      - main
      - work

jobs:
  lint:
    name: Lint
    uses: ./.github/workflows/node-base.yml
    with:
      run: npm run lint
      summary-title: Lint

  token-guard:
    name: Token Guard
    uses: ./.github/workflows/node-base.yml
    with:
      run: npm run token-guard
      summary-title: Token Guard

  typecheck:
    name: Typecheck
    uses: ./.github/workflows/node-base.yml
    with:
      run: npm run typecheck
      summary-title: Typecheck

  unit:
    name: Unit Tests
    uses: ./.github/workflows/node-base.yml
    with:
      run: npm test -- --run
      summary-title: Unit Tests

  a11y:
    name: Accessibility
    uses: ./.github/workflows/node-base.yml
    with:
      run: |
        set -euo pipefail

        LIST_OUTPUT=$(npx playwright test --list --project=chromium --grep "@axe") || true

        npm run build

        PORT=3000
        npm run start -- --hostname 127.0.0.1 --port "$PORT" &
        SERVER_PID=$!

        cleanup() {
          if kill -0 "$SERVER_PID" 2>/dev/null; then
            kill "$SERVER_PID"
            wait "$SERVER_PID" || true
          fi
        }

        trap cleanup EXIT

        for attempt in $(seq 1 30); do
          if curl --fail --silent --head "http://127.0.0.1:${PORT}" >/dev/null; then
            READY=1
            break
          fi
          sleep 2
        done

        if [ -z "${READY:-}" ]; then
          echo "Server failed to start" >&2
          exit 1
        fi

        OUTPUT_DIR="playwright-results/a11y"
        if echo "$LIST_OUTPUT" | grep -q "@axe"; then
          npx playwright test \
            --project=chromium \
            --reporter=line \
            --trace=retain-on-failure \
            --output="$OUTPUT_DIR" \
            --grep "@axe"
        else
          echo "No @axe-tagged tests detected; running full suite." >&2
          npx playwright test \
            --project=chromium \
            --reporter=line \
            --trace=retain-on-failure \
            --output="$OUTPUT_DIR"
        fi
      summary-title: Accessibility
      install-playwright: true
      artifact-name: playwright-a11y-artifacts
      artifact-path: |
        playwright-results/a11y
      artifact-on-failure: true

  build:
    name: Build
    needs:
      - lint
      - typecheck
      - unit
      - token-guard
      - a11y
    uses: ./.github/workflows/node-base.yml
    with:
      run: |
        set -euo pipefail
        npm audit --audit-level=moderate --json > audit-report.json || AUDIT_STATUS=$?
        if [ -n "${AUDIT_STATUS:-}" ] && [ "$AUDIT_STATUS" -ne 0 ]; then
          echo "npm audit reported issues below the high severity threshold."
        fi
        node scripts/audit-ci-report.mjs audit-report.json
        npm run build
      cache-path: .next/cache
      artifact-name: next-build
      artifact-path: |
        .next
      summary-title: Build

  e2e:
    name: E2E (${{ matrix.project }})
    needs:
      - build
    strategy:
      fail-fast: false
      matrix:
        project:
          - chromium
          - firefox
          - webkit
    uses: ./.github/workflows/node-base.yml
    with:
      run: |
        set -euo pipefail
        OUTPUT_DIR="playwright-results/${{ matrix.project }}"
        LIST_OUTPUT=$(npx playwright test --list --project=${{ matrix.project }} --grep "@axe") || true
        if echo "$LIST_OUTPUT" | grep -q "@axe"; then
          npx playwright test \
            --project=${{ matrix.project }} \
            --reporter=line \
            --trace=retain-on-failure \
            --output="$OUTPUT_DIR" \
            --grep "@axe"
        else
          echo "No @axe-tagged tests detected; running full suite." >&2
          npx playwright test \
            --project=${{ matrix.project }} \
            --reporter=line \
            --trace=retain-on-failure \
            --output="$OUTPUT_DIR"
        fi
      summary-title: E2E ${{ matrix.project }}
      install-playwright: true
      artifact-name: playwright-${{ matrix.project }}-artifacts
      artifact-path: |
        playwright-results/${{ matrix.project }}
      artifact-on-failure: true
